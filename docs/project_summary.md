# **ホイッスル型ブレスコントローラー「UniSuling」 要件定義書**

## **1\. 背景と目的**

### **1.1. 背景**

市販の電子管楽器は多機能である一方、よりシンプルに「息」による音楽表現に特化したデバイスへの需要が存在する。本プロジェクトでは、既存のDIYプロジェクトの知見を活かしつつ、運指キーなどを排したミニマルな設計思想に基づき、独自のMIDIコントローラーを開発する。

### **1.2. 目的**

息の強弱だけで音楽表現が可能な、シンプルかつ表現力豊かなUSB-MIDIコントローラーを開発する。完成したデバイスは、PC/MacにUSB接続するだけで、特別なドライバーなしにDAWやソフトウェアシンセサイザー（特にWebベースのTone.jsなど）からMIDIデバイスとして認識され、演奏可能になることを目指す。

## **2\. システム概要**

### **2.1. コンセプト**

「息で奏でる、単音の楽器」。運指キーを持たず、あらかじめ設定された単一の音程を、息の吹き込み（アタック）、持続（サステイン）、停止（リリース）だけでコントロールする。息の強弱は音量や音色変化にリアルタイムに反映される。

### **2.2. システム構成図**

graph TD  
    Mouth\[口\] \--\> Mouthpiece\[マウスピース(I型ジョイント)\];  
    Mouthpiece \--\> Sensor\[圧力センサー\];  
    Sensor \--\> ESP32\[ESP32-S2/S3\];  
    ESP32 \--\> LED\[オンボードLED \<br\> (視覚フィードバック)\];  
    ESP32 \-- USB \--\> PC\[PC/Mac \<br\> (DAW, Tone.js)\];

## **3\. ハードウェア仕様**

### **3.1. 主要部品リスト**

| 部品名 | 型番/仕様 | 数量 | 備考 |
| :---- | :---- | :---- | :---- |
| マイクロコントローラー | ESP32-S2-DevKitM-1-N4R2 または ESP32-S3搭載ボード | 1 | ネイティブUSB対応必須 |
| 圧力センサー | MIS-2503-015G (3.3V ゲージ圧) | 1 |  |
| バイパスコンデンサ | 0.1μF (104) セラミックコンデンサ | 1 | センサー電源安定化用 |
| マウスピース | I型チューブジョイント (内径3mm程度に対応) | 1 |  |
| チューブ | 内径3mm シリコンチューブ | 適量 | マウスピース、センサー接続用 |
| 筐体 | 透明なプラスチック容器 (タッパーウェアなど) | 1 |  |
| USBケーブル | ESP32ボードのポートに適合するもの | 1 |  |
| 接続線材 | ブレッドボード、ジャンパーワイヤー | 一式 | 試作用 |

### **3.2. 結線**

* **センサー VDD** → ESP32 **3V3**  
* **センサー GND** → ESP32 **GND**  
* **センサー VOUT** → ESP32 **GPIO2** (ADC1)  
* **バイパスコンデンサ** → センサーのVDDピンとGNDピンの間に接続

### **3.3. マウスピース構造**

* **方式**: 息が抜けない**閉鎖型**とする。唾液を排出するドレンは設けない。  
* **構造**: I型チューブジョイントをマウスピースの核として利用する。歯が当たる部分にはシリコンチューブを被せ、唇へのフィット感を向上させると共に、噛んだ際にチューブが完全に潰れないようにする。

## **4\. ソフトウェア仕様**

### **4.1. 機能要件**

1. 息を吹き込むと、あらかじめ設定された固定のMIDIノートオン信号を送信すること。  
2. 息を止めると、MIDIノートオフ信号を送信すること。  
3. 演奏中の息の強弱を、リアルタイムにMIDIチャンネルアフタータッチ信号として送信すること。  
4. USB経由でPC/Macに接続し、クラスコンプライアントMIDIデバイスとして動作すること。  
5. 息の強弱を、ESP32ボード上のオンボードRGB LEDの明るさ・色で視覚的にフィードバックすること。

### **4.2. MIDI信号仕様**

| 機能 | MIDI信号 | トリガー | 詳細 |
| :---- | :---- | :---- | :---- |
| **音の開始** | ノートオン | 息圧が閾値を超えた瞬間 | ノートナンバーは固定値。ヴェロシティは息の初期の強さに応じて決定 (1-127)。 |
| **音の停止** | ノートオフ | 息圧が閾値を下回った瞬間 |  |
| **持続音の強弱** | チャンネルアフタータッチ | ノートオン中の息圧の変化 | 息圧の値をブレスカーブで変換し、連続的に送信 (0-127)。CC\#11 (Expression) での代替も検討可。 |

### **4.3. プログラムロジック・要求仕様**

* **ブレス検知**: 息の吹き始めと停止を判断するための圧力閾値（Threshold）を、ソースコード上で容易に調整可能な定数として設けること。  
* **ブレスカーブ**: センサーのアナログ値 (0-4095) をMIDI値 (0-127) に変換する際、演奏感を調整するための非線形な変換カーブ（例: 指数関数 pow(x, exponent)) を実装すること。カーブの特性（例: exponentの値）はソースコード上で容易に調整可能であること。  
* **視覚フィードバック**: ESP32ボードのオンボードRGB LED (GPIO18) を制御し、息の強さに応じて明るさや色（例: 弱:青 → 強:赤）が変化するように実装すること。  
* **状態管理**: ノートがONかOFFかを管理するフラグ変数を持ち、意図しないノートオン/オフの重複送信を防ぐこと。

### **4.4. 将来的な拡張**

* 本バージョンでは搭載しないが、将来的に可変抵抗やリニアタッチセンサーを追加し、ピッチベンドなどのMIDI信号をコントロールする機能を拡張予定とする。

## **5\. 筐体仕様**

* **材質**: 透明または半透明のプラスチック。ダイソーのタッパーウェアなどを想定。  
* **加工**: 以下のポート用の穴あけ加工を行う。  
  * ESP32ボードのUSBポートアクセス用  
  * 息を吹き込むマウスピース（I型ジョイント）用  
* **内部固定**: ESP32ボードとセンサー基板は、スペーサーやホットボンドなどで内部に固定する。

## **6\. 開発環境**

* **IDE**: Arduino IDE  
* **主要ライブラリ**:  
  * **Adafruit TinyUSB Library**: USB-MIDI通信のため  
  * **Adafruit NeoPixel Library**: オンボードRGB LED制御のため  
* **対象ボード**: ESP32-S2, ESP32-S3
